# ML System Design Doc - RU  
## Дизайн ML системы — Оценка операторов по транскриптам — MVP v1.0

---

### 1. Цели и предпосылки

#### 1.1. Зачем идем в разработку продукта?

- **Бизнес-цель:** увеличить долю оценённых обращений операторов с <1% до не менее 10%.
- **Ожидаемое улучшение:** снижение зависимости от ручной оценки, повышение масштабируемости и единообразия оценок.
- **Критерий успеха итерации:** ≥80% совпадения с оценкой QA-специалистов на тестовой выборке.

#### 1.2. Бизнес-требования и ограничения

- **Краткое описание БТ:** автоматическая оценка звонков операторов клиентского сервиса по текстовым транскрипциям с использованием ML.
- **Ограничения:**
  - Используются только обезличенные данные.
  - Использование инфраструктуры локального исполнения (без внешних API).
- **Ожидания от итерации:** batch-оценка ≥10% ежедневных транскрипций.
- **Интеграция в бизнес-процесс:** результаты передаются в систему мониторинга качества и используются для KPI/обратной связи.
- **Критерий успешного пилота:** ≥80% согласованности оценок с QA, устойчивость обработки заданного объема выборки.

#### 1.3. Скоуп

- **Входит:**
  - Batch-инференс.
  - Модель оценки по критериям (0–2).
  - Формирование отчёта (оценки + объяснения).
- **Не входит:**
  - Real-time инференс.
  - Интеграция с KPI-системами на уровне продакшена.
  - Полный UI.
- **Качество решения:** воспроизводимый код, изолированное окружение через Poetry, единый пайплайн подготовки данных и инференса.
- **Планируемый технический долг:** оптимизация latency, переход к real-time.

#### 1.4. Предпосылки

- Исходные данные — транскрипты, полученные из STT.
- Доступна историческая экспертная разметка (QA).
- Объём данных ~1000 звонков в сутки.
- ПД скрыты на уровне транскрибации.

---

### 2. Методология

#### 2.1. Постановка задачи

- Тип задачи: автоматизированная многокритериальная оценка диалогов (multi-label classification) с диапазоном значений `0–2` по каждому критерию + текстовое пояснение.

#### 2.2. Блок-схема решения (MVP)

```
[Транскрипты] → [Предобработка] → [LLM scoring (GPT-OSS 20B via vLLM)] 
        → [Стандартизация оценок] → [Сохранение результатов] → [Сравнение с QA]
```

#### 2.3. Этапы

**Этап 1 — Подготовка данных**

| Данные | Источник | Роли | Проверка качества |
|--------|----------|------|-------------------|
| Транскрипты звонков | STT система | DS/DE | + |
| Разметка QA | Внутренний репозиторий QA | DS/DE | + |
| Метаданные звонков | Внутренние системы | DS/DE | частично |

**Результат этапа:** витрина `<transcript, qa_score, metadata>`.

---

**Этап 2 — Бейзлайн**

- Подход: zero/few-shot prompting.
- Модель: GPT-OSS 20b (vLLM).
- Метрики: Cohen’s Kappa, Accuracy per criterion.
- Ожидаемый результат: kappa ≥0.6.

---

**Этап 3 — MVP модель**

- Подход: few-shot prompting + fine-tuning на исторической разметке.
- Выборка: train/test на исторических данных.
- Метрики качества: Cohen’s Kappa ≥0.8, стабильность оценок по критериям.
- Риски: несбалансированность классов, drift данных.

---

**Этап 4 — Инференс**

- Режим: batch ежедневно.
- Выход модели: оценки по критериям + короткое текстовое объяснение.
- Формат выгрузки: JSON + табличная форма для аналитики.

---

**Этап 5 — Валидация**

- Проверка выборки QA специалистами для подтверждения согласованности оценок.

---

### 3. Подготовка пилота

#### 3.1. Способ оценки

- Сравнение модельных оценок с ручными оценками QA на отложенной выборке (A/B).
- Контрольная доля: ~20% модельно-оценённых диалогов.

#### 3.2. Условия успешности

- Cohen’s Kappa ≥0.8.
- Обработка ≥10% суточных транскриптов.

#### 3.3. Ограничения вычислений

- Инференс self-hosted через vLLM.
- Точная стоимость вычислений будет уточнена после расчёта медианного времени инференса на бейзлайне.

#### 3.4. Блок схема решения

Транскрипт → Предобработка → LLM-оценка → Оценки по критериям (0–2) + Пояснение → Сохранение результата → Отчет для QA/бизнеса

---

### 4. Внедрение (черновой уровень)

#### 4.1. Архитектура

```
ETL → vLLM scoring service → Storage → Reporting layer
```

#### 4.2. Инфраструктура

- Развертывание локально.
- Масштабирование через vLLM (горизонтально при необходимости).

#### 4.3. Требования

- До real-time требований нет.
- Основной KPI — покрытие 10%.

#### 4.4. Безопасность

- Все входные данные обезличены.
- Обработка ведется в периметре компании.

#### 4.5. Стоимость

- Основная нагрузка — GPU инференс модели vLLM.

#### 4.6. Риски

- Дрейф данных.
- Недостаточная согласованность модели и QA в отдельных сценариях.
- Потенциальная деградация при изменении STT-модели.

---


## 2. Этапы решения задачи 

Данный раздел описывает поэтапное решение задачи автоматической оценки операторов по транскриптам звонков с точки зрения Data Scientist. Описание основано на результатах предварительного анализа данных (EDA) и отражает специфику текущей задачи, доступных данных и бизнес-целей.

---

### Этап 1. Подготовка и валидация данных

#### Данные и сущности

Основной объект анализа — звонок, представленный в виде одного текстового транскрипта (на русском языке), полученного от STT-системы.  
Средняя длина транскрипта составляет ~2000 символов (~315 слов), что укладывается в контекстное окно используемой LLM.

Используется историческая QA-разметка по 11 критериям качества, каждый из которых оценивается по шкале `0 / 1 / 2`. Пропуски в разметке отсутствуют. Распределение классов существенно несбалансировано с доминированием значения `2`.

**Логическая структура данных:**

- Таблица звонков (features):
  - call_id  
  - transcript_text  
  - checklist_type  
  - служебные метаданные звонка (в текущей итерации не используются как признаки)

- Таблица целевых переменных:
  - call_id  
  - criterion_name  
  - qa_score ∈ {0,1,2}

- Таблица результатов модели:
  - call_id  
  - criterion_name  
  - model_score ∈ {0,1,2}  
  - model_explanation  

#### Источники данных

| Название данных | Источник | Ресурсы | Качество |
|----------------|----------|---------|----------|
| Транскрипты звонков | STT-система | DE / DS | + |
| QA-разметка | Внутренний репозиторий QA | DS | + |
| Метаданные звонков | Внутренние системы | DE | + |

#### Результат этапа
- Сформирована единая витрина `<call_id, transcript_text, checklist_type, qa_scores[11]>`
- Подтверждена применимость транскриптов для LLM-инференса без дополнительной очистки
- Зафиксированы риски: дисбаланс классов, нестабильность критерия «Холд»

---

### Этап 2. Бейзлайн-оценка (Zero / Few-shot LLM)

#### Цель этапа
Проверить применимость LLM-подхода для автоматической оценки качества звонков и оценить достижимый уровень согласованности с QA без обучения модели.

#### Формирование выборки
- Объём: 181 звонок  
- Период: случайная выборка за 2 недели  
- Разделение: единая тестовая выборка  
- Стратификация: не применяется  

#### Техника решения (бейзлайн)
- Модель: GPT-OSS 20B (vLLM, self-hosted)
- Один prompt на звонок, оценивающий все 11 критериев
- Формат ответа: строго JSON
- Выход: оценки + краткие пояснения по каждому критерию

#### Метрики качества
- Cohen’s Kappa:
  - по каждому критерию
  - агрегированная по всем критериям
- Минимально приемлемый порог: Kappa ≥ 0.7 (агрегированно)

#### Результат этапа
- Подтверждение применимости LLM
- Выявление слабых критериев (ожидаемо — «Холд»)
- Решение о необходимости fine-tuning

#### Риски
- Дисбаланс классов
- Ошибки разметки спикеров (Клиент / Оператор)

#### Бизнес-проверка
- Side-by-side сравнение оценок модели и QA

---

### Этап 3. Основная MVP-модель (Few-shot + Fine-tuning)

#### Цель этапа
Достижение устойчивой согласованности с QA, достаточной для пилота (≥10% покрытия звонков).

#### Формирование выборки
- Объём: < 5k звонков
- Разделение: train / test
- Временная валидация: не применяется
- Балансировка классов: не применяется

#### Техника решения
- Instruction-tuning + LoRA
- Одна модель на все критерии
- Генерация оценок и пояснений в одном ответе

#### Метрики качества
- Основная метрика: Cohen’s Kappa
- Целевое значение: Kappa ≥ 0.8 (агрегированно)
- Критичная ошибка: заниженная оценка

#### Результат этапа
- Стабильная модель оценки качества звонков
- Воспроизводимые результаты по критериям

#### Риски
- Нестабильность критерия «Холд»
- Ошибки разметки ролей в транскриптах

#### Бизнес-проверка
- Side-by-side сравнение модельных и QA-оценок

---

### Этап 4. Подготовка и итерации инференса

#### Инференс
- Режим: batch
- Частота: ежедневно
- Производительность: до 400 звонков в час

#### Версионирование
- Версии модели
- LoRA-веса
- Промпты

#### Результат этапа
- Воспроизводимый batch-пайплайн
- Готовность к пилоту (≥10% покрытия)
